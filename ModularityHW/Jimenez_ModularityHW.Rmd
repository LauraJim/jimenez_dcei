---
title: "Jimenez_ModularityHW"
author: "Laura Jiménez"
date: "March 2018"
output: html_document
#bibliography: ModularityHW_refs.bib
#csl: Science.csl
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = F)
```

<!---```{r check, echo=F, cache=T, message=F, warning=F}
library(checkpoint)
dir.create(file.path(tempdir(),".checkpoint"),recursive=T,showwarnings=F)
checkpoint("2018-03-14",checkpointLocation=tempdir())
```-->

```{r Funmtime}
mtime <- function(files)
{
  lapply(Sys.glob(files),function(x) {X = file.info(x)$mtime})
}
```

## Abstract

# Introduction
Understanding the observed climate trends for the United States in terms of regional characteristics and hemispheric perspectives is importan to assess regional changes and to understand further the global climate system. Further, the anthropogenic climate change signal is projected to be stronger in the high-latitudes (Nicholls et al., 1996). This suggests that it might be easier to detect climate change in a country like the USA.
Use first research question as main idea:
1) Can we see climate warming for ourselves by analysing these data?
An important aspect in climate change research is the study of change weather and climate extremes...
Here we analyze the spatial and temporal characteristics of change in annual mean temperature and precipitation across the United States along the period 1950-2010...
# Methods

## Data
-
```{r data, cache=T, cache.extra=list(mtime("USAAnnualTemp1950_2008.rds"),mtime("USAAnnualPcpn1950_2008.rds"))}
# provided == T, if data are stored in the same directory as the code
# provided == F, if the data will be downloaded from a website
provided <- T
files <- c("USAAnnualTemp1950_2008.rds","USAAnnualPcpn1950_2008.rds")
if(provided==T)
{
  temp <- readRDS(files[1])
  prec <- readRDS(files[2])
}
# both files should be data.frame objects
str(temp)
str(prec)
```

```{r cleaning, cache=T}
# Function that gets rid of stations with less than a minimum number of observations and transform the data to a matrix
# 'dats' must be a data frame object with the following variables: state, name, lon, lat, data, year
# 'minY' is the minimum number of years that a station must contain to be included in the final dataset
# Output: a matrix with the cleaned data
cleanTP <- function(dats,minY)
{
  # Filtering data by weather station name and removing NA's
  filter1 <- aggregate(data~name,dats,length,na.action = na.omit)
  # Removing the weather stations with less than "minY" years of data
  filter2 <- subset(filter1,filter1$data >= minY)$name
  # Select the stations in filter2 from the original dataset
  filter3 <- subset(dats,subset=dats$name%in%filter2,selec=c(lon,lat,data,year))
  years <- unique(filter3$year)
  nyear <- length(years)
  year01 <- range(years)
  mclean <- matrix(as.vector(filter3$data),nrow=nyear)
  lonlat <- cbind(filter3$lon,filter3$lat)
  return(list(mclean,lonlat,year01))
}

# Now use the function for cleaning both the temperature and the precipitation datasets:
temp.cl <- cleanTP(temp,40)
temp.obs <- temp.cl[[1]]
temp.obs[1:8,1:8]
dim(temp.obs)
prec.cl <- cleanTP(prec,40)
prec.obs <- prec.cl[[1]]
prec.obs[1:8,1:8]
dim(prec.obs)
```

Figure X shows the locations if the n1 temperature and n2 precipitation stations used in this study. Remember that we got rid of the stations with less than 40 years of data.
```{r mapData}
# showing the temp and prec trends in each location (maps package)
library(maps)
# map of the USA with state divisions
map('state', fill = F)
# extract the unique coordinate pairs from filter3 to plot the stations
temp.sts <- temp.cl[[2]][nrow(temp.obs)*(1:ncol(temp.obs)),]
prec.sts <- prec.cl[[2]][nrow(prec.obs)*(1:ncol(prec.obs)),]
# show location of stations
points(temp.sts,pch=19,col="orange")
points(prec.sts,pch=19,col="blue")
# now color the points according to the temp or prec measurements

```

## Environmental trends
Non-parametric test were developed for use in environmental impact assesment because scientists were concerned that the statistical features of messy environmental data would make difficult to use parametric procedures (references). Temperature and precipitation time series may contain one or more of a number of properties which are undesirable for use with parametric tests. Moreover, data are censored or or the time series contain a lot of missing values. We used a nonparametric test which is designed for checking for the presence of a trend that may be contained in the data. So, the outputs may not give an indication of the type or magnitude of the trend. Here, we used the Mann-Kendall trend test which is a special case of the Kendall rank correlation test (reference).  
We aplied a Mann-Kendall test to the temperature and precipitation time series to check for the presence of a trend. The Mann-Kendall test is a nonparametric test for randomness against time, i.e., it cotrasts the null hypothesis that the data come from a population where the random variables are independent and identically distributed against the alternative hypothesis that the data follow a monotonic trend over time. We calculated the values of the Mann-Kendall test statistic, S, under the null hypothesis by using the function 'Kendal' in R. A positive value of S indicates that there is an upward trend in which the observations increase with time. A negative value of S means that there is  downward trend. If the value of S is significantly different from zero, we reject the null hypothesis at a chosen significance level (0.95, in our case) and have evidence of the presence of a monotonic trend.
```{r trends}
# plot the times series for each station
ys <- temp.cl[[3]]
nsts <- ncol(temp.obs)
plot(ys[1]:ys[2],temp.obs[,1],type="l",las=2,xlab="Year",ylab="Annual temperature",col="gray",ylim=c(20,80))
for(i in seq(2,nsts,by=25))
  lines(ys[1]:ys[2],temp.obs[,i],col="gray")
# apply a Mann-Kendall test for each time series (each column in temp.obs/pcpn.obs)
library(Kendall)
alpha <- 0.05
scores <- rep(0,nsts)
for(j in 1:nsts)
{
  res <- MannKendall(temp.obs[,j])
  if(res$sl[1]<alpha) # reject the null hypothesis
  {
    if(res$S[1]>0) # positive trend
      scores[j] <- 1
    else # negative trend
      scores[j] <- -1
  }
}

```

# Results
Answer the research questions:
2) In what parts of the country are temperatures getting warmer? Are there any parts that actually got colder over 1905-2010?
3) Can we say, based on these data, that a change in precipitation has occurred over this period?

# Discussion

# References